(function(window){"use strict";var appUrl,hostUrl,queryParams,executor,baseUrl,targetStr,notAnApp_FlagSum=0,webPropertiesStorage={"appWebProperties":{isUnloaded:true},"hostWebProperties":{isUnloaded:true}},say,rest,jsom,inAppMode=true,isReady=false,initTimer,spyreqs,spyreqs_version="0.0.36";if(!(window.performance)){window.performance={};}
if(!(window.performance.now)){window.performance.now=function(){return Date.now();}}
initSay();initSpyreqs();function initSay(){if(typeof window.console!=='undefined'){say=function(what){window.console.log(what);};}else if((typeof window.top!=='undefined')&&(typeof window.top.console!=='undefined')){say=function(what){window.top.console.log(what);};}else if((typeof window.opener!=='undefined')&&(typeof window.opener.console!=='undefined')){say=function(what){window.opener.console.log(what);};}else{say=function(){};}}
function initSpyreqs(){var initModeMsg="",windowDefaultRepo=window.localStorage;queryParams=urlParamsObj();if(typeof queryParams.SPAppWebUrl!=='undefined'){appUrl=decodeURIComponent(queryParams.SPAppWebUrl);if(appUrl.indexOf('#')!==-1){appUrl=appUrl.split('#')[0];}}else if(windowDefaultRepo.spyreqsAppUrl){appUrl=windowDefaultRepo.spyreqsAppUrl;initModeMsg="storage";}else{notAnApp_FlagSum++;}
if(typeof queryParams.SPHostUrl!=='undefined'){hostUrl=decodeURIComponent(queryParams.SPHostUrl);prepRest();}else if(windowDefaultRepo.spyreqsHostUrl){hostUrl=windowDefaultRepo.spyreqsHostUrl;initModeMsg="storage";prepRest();}else{notAnApp_FlagSum++;}
if(notAnApp_FlagSum!=0){if(discoverIfApp(window.location.host)){appUrl=decodeURIComponent(tryBuildAppUrl());hostUrl=decodeURIComponent(tryBuildHostUrlFromAppUrl(appUrl));prepRest();initModeMsg="app - auto discover";say("spyreqs assumed: appUrl: "+appUrl+" - hostUrl:"+hostUrl);}else{iAmNotInApp();}}else{if(initModeMsg==""){initModeMsg="app";}}
say("spyreqs init mode: "+initModeMsg);if(initModeMsg!="no app"){windowDefaultRepo.spyreqsAppUrl=appUrl;windowDefaultRepo.spyreqsHostUrl=hostUrl;}
function prepRest(){if(SP.RequestExecutor){targetStr="&@target='"+hostUrl+"'";baseUrl=appUrl+"/_api/SP.AppContextSite(@target)/";executor=new SP.RequestExecutor(appUrl);}else{say("SP.RequestExecutor not available");}}
function tryBuildHostUrlFromAppUrl(appUrl){var temphostUrl=removeLastSlash(appUrl);var domain=window.location.host.split('.')[0],parts=domain.split('-'),hash=parts[parts.length-1];return temphostUrl.replace("-"+hash,"");}
function tryBuildAppUrl(){if(_spPageContextInfo&&_spPageContextInfo.webAbsoluteUrl){appUrl=_spPageContextInfo.webAbsoluteUrl;}
else{if(!window.location.origin){window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?':'+window.location.port:'');}
appUrl=window.location.origin+removeLastSlash(window.location.pathname);if(appUrl.toLowerCase().substring(appUrl.length-"/Pages".length)=="/pages"){appUrl=appUrl.slice(0,appUrl.lastIndexOf("/"));}}
return appUrl;}
function removeLastSlash(url){return url.slice(0,url.lastIndexOf("/"));}
function iAmNotInApp(){initModeMsg="no app";inAppMode=false;var url=window.location.href,tryAt,urlPart,lookForArr=["/Pages","/15","/SitePages"],buildUrlArr=["/_layouts/15/SP.RequestExecutor.js","/15/SP.RequestExecutor.js","/SitePages/_layouts/15/SP.RequestExecutor.js"];if(_spPageContextInfo&&_spPageContextInfo.webAbsoluteUrl){urlPart=_spPageContextInfo.webAbsoluteUrl;tryAt=urlPart+buildUrlArr[0];appUrl=hostUrl=urlPart;}
else
{for(var ind=0;ind<3;ind++){urlPart=url.substring(0,url.indexOf(lookForArr[ind]));if(urlPart.length>1){appUrl=hostUrl=urlPart;tryAt=urlPart+buildUrlArr[ind];break;}}}
if(urlPart.length>1){say("spyreqs tries to get: "+tryAt);$.getScript(tryAt).done(function(script,textStatus){say('loaded: RequestExecutor.js');executor=new SP.RequestExecutor(hostUrl);targetStr="&@target='"+hostUrl+"'";baseUrl=appUrl+"/_api/SP.AppContextSite(@target)/";}).fail(function(script,textStatus){say('could not load: RequestExecutor.js');});}else{console.log("spyreqs not in SharePoint 2013");}}
function discoverIfApp(theurl){var domain=theurl.split('.')[0],parts=domain.split('-'),hash=parts[parts.length-1];return(hash.length==14);}}
function testReady(){if(!isReady){SP.SOD.executeFunc('sp.js','SP.ClientContext.get_current',function(){say('loaded: sp.js');if(!isReady){say('spyreqs ready, ver '+spyreqs_version);isReady=true;if(typeof window.onSpyreqsReady=='function'){window.onSpyreqsReady();}}
clearInterval(initTimer);});}else{clearInterval(initTimer);}}
function _fileReaderRead(file){var fileReaderDefer=new $.Deferred();var reader=new FileReader();reader.onload=function(event){fileReaderDefer.resolve(event.target.result);};reader.onerror=function(event){fileReaderDefer.reject({error:e.target.error})};reader.onprogress=function(event){fileReaderDefer.notify(event);}
reader.readAsArrayBuffer(file);return fileReaderDefer.promise();}
function postAsync(url){var defer=new $.Deferred();executor.executeAsync({url:url,method:'POST',headers:{Accept:"application/json;odata=verbose"},success:defer.resolve,error:defer.reject});return defer.promise();}
function getAsync(url){var defer=new $.Deferred();executor.executeAsync({url:url,method:"GET",dataType:"json",headers:{Accept:"application/json;odata=verbose"},success:function(data){defer.resolve(JSON.parse(data.body));},fail:function(error){defer.reject(error);},error:function(error){defer.reject(error);}});return defer.promise();}
function getFile(url){var defer=new $.Deferred();executor.executeAsync({url:url,method:"GET",success:function(data){defer.resolve(data.body);},fail:function(error){defer.reject(error);},error:function(error){defer.reject(error);}});return defer.promise();}
function addFile(url,file){var defer=new $.Deferred();executor.executeAsync({url:url,method:"POST",headers:{"Accept":"application/json;odata=verbose"},contentType:"application/json;odata=verbose",body:file,success:function(data){defer.resolve(JSON.parse(data.body));},fail:function(error){defer.reject(error);},error:function(error){defer.reject(error);}});return defer.promise();}
function addBinaryFile(url,file,xhrObj){var deferred=new $.Deferred(),xhr=xhrObj||new XMLHttpRequest();function upload(url,arrayBuffer){var uploadDefer=new $.Deferred();$.ajax({url:url,type:"POST",data:arrayBuffer,processData:false,headers:{"accept":"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val()},xhr:function(){if(xhr.upload){xhr.upload.addEventListener("progress",function(evt){if(evt.lengthComputable){uploadDefer.notify(evt.loaded,(evt.loaded/evt.total));}},false);}
return xhr;},success:function(data){uploadDefer.resolve(data);},error:function(err){uploadDefer.reject(err);}});return uploadDefer.promise();}
_fileReaderRead(file).then(function(arrayBufferData){upload(url,arrayBufferData).then(function(response){deferred.resolve(response);},function(error){deferred.reject(error);},function(bytesLoaded,progress){deferred.notify(bytesLoaded,progress);})},function(fileReaderError){deferred.reject(fileReaderError);});return{xhr:xhr,handler:deferred.promise()};}
function addFolder(url,data){var defer=new $.Deferred();executor.executeAsync({url:url,method:"POST",headers:{"ACCEPT":"application/json;odata=verbose","Content-Type":"application/json;odata=verbose"},contentType:"application/json;odata=verbose",body:JSON.stringify(data),success:function(data){defer.resolve(JSON.parse(data.body));},fail:function(error){defer.reject(error);},error:function(error){defer.reject(error);}});return defer.promise();}
function deleteAsync(url,etag){var defer=new $.Deferred();executor.executeAsync({url:url,method:"POST",headers:{"Accept":"application/json;odata=verbose","X-HTTP-Method":"DELETE","If-Match":etag?etag:"*"},success:function(data){defer.resolve(data);},fail:function(error){defer.reject(error);},error:function(error){defer.reject(error);}});return defer.promise();}
function updateAsync(url,data){var defer=new $.Deferred();executor.executeAsync({url:url,method:"POST",body:JSON.stringify(data),headers:{"Accept":"application/json;odata=verbose","Content-Type":"application/json;odata=verbose","X-HTTP-Method":"MERGE","If-Match":(data.__metadata&&data.__metadata.etag)?data.__metadata.etag:"*"},success:function(data){defer.resolve(data);},fail:function(error){defer.reject(error);},error:function(error){defer.reject(error);}});return defer.promise();}
function createAsync(url,data){var defer=new $.Deferred();executor.executeAsync({url:url,method:"POST",body:JSON.stringify(data),headers:{Accept:"application/json;odata=verbose","Content-Type":"application/json;odata=verbose"},success:function(data){defer.resolve(JSON.parse(data.body));},fail:function(error){defer.reject(error);},error:function(error){say("ajax error:"+error.statusText);defer.reject(error);}});return defer.promise();}
function checkQuery(query){if(typeof query==='undefined'||(typeof query!=='string'&&!(query instanceof String))){return'';}
return query;}
function newRemoteContextInstance(){var returnObj={},context,factory,appContextSite;if(!SP.ClientContext){say("SP.ClientContext not loaded");return null;}
context=new SP.ClientContext(appUrl);factory=new SP.ProxyWebRequestExecutorFactory(appUrl);context.set_webRequestExecutorFactory(factory);appContextSite=new SP.AppContextSite(context,hostUrl);returnObj.context=context;returnObj.factory=factory;returnObj.appContextSite=appContextSite;return returnObj;}
function newLocalContextInstance(){var returnObj={},context,appContextSite;if(!SP.ClientContext){say("SP.ClientContext was not loaded, loading now. Please try again");SP.SOD.executeFunc('sp.js','SP.ClientContext.get_current',function(){say('loaded: sp.js, spyreqs ready');});return null;}
if(spyreqs.spContext!=null){context=spyreqs.spContext;}else if(!inAppMode){context=new SP.ClientContext.get_current();}else{context=new SP.ClientContext(appUrl);}
returnObj.context=context;returnObj.appContextSite=context;return returnObj;}
function urlParamsObj(){if(window.location.search){var param_array=document.location.search.substring(1).split('&'),theLength=param_array.length,params={},i=0,x;for(;i<theLength;i++){x=param_array[i].toString().split('=');params[x[0]]=x[1];}
return params;}
return{};}
function buildQueryString(str,param,val){var ind=str.indexOf('?');if(ind>-1){var param_array=str.substring(ind+1).split('&');var params={};var theLength=param_array.length;for(var i=0;i<theLength;i++){var x=param_array[i].toString().split('=');params[x[0]]=x[1];}
params[param]=val;var attached="?";for(var key in params){attached+=key+"="+params[key]+"&";}
attached=attached.substr(0,attached.length-1);return String(str.substr(0,ind)+attached);}
return String(str+"?"+param+"="+val);}
function mirrorAppFunctions(obj,properties){var keys,newKey;properties.forEach(function(prop){keys=Object.keys(obj[prop]);keys.forEach(function(key){if(key.indexOf('App')!==-1){newKey=key.replace('App','Web');obj[prop][newKey]=obj[prop][key];}});});return obj;}
rest={createList:function(url,list){var data={"__metadata":{type:"SP.List"},BaseTemplate:list.Template,Title:list.Title};return createAsync(url,data);},addListField:function(url,field,fieldType){field.__metadata={type:(typeof fieldType!=='undefined')?fieldType:'SP.Field'};return createAsync(url,field);}};jsom={createListFields:function(context,SPlist,fieldsObj){var field,defer,result;field=fieldsObj.shift();createListField();function createListField(){var xmlStr,choice,attr;if(typeof defer==='undefined'){defer=new $.Deferred();}
if(typeof field.Type==='undefined'){field.Type="Text";}
if(typeof field.DisplayName==='undefined'){field.DisplayName=field.Name;}
if(field.Type!=='Lookup'){xmlStr='<Field ';for(attr in field){if(attr!=='choices'){xmlStr+=attr+'="'+field[attr]+'" ';}}
xmlStr+='>';if(field.Type==='Choice'){xmlStr+='<CHOICES>';field.choices.forEach(function(choice){xmlStr+='<CHOICE>'+choice+'</CHOICE>';});xmlStr+='</CHOICES>';}
xmlStr+='</Field>';}else{xmlStr+='';}
result=SPlist.get_fields().addFieldAsXml(xmlStr,true,SP.AddFieldOptions.defaultValue);context.load(SPlist);context.executeQueryAsync(success,fail);}
function success(){if(fieldsObj.length>0){field=fieldsObj.shift();createListField();}else{defer.resolve(result);}}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},createList:function(c,listObj){var web,theList,listCreationInfo,template,field,defer=new $.Deferred(),val_temp,fn_temp,isValidAttrBool,lciAttrs=["url","description","documentTemplateType","customSchemaXml","dataSourceProperties","quickLaunchOption","templateFeatureId"],listAttrs=["contentTypesEnabled","defaultContentApprovalWorkflowId","defaultDisplayFormUrl","defaultEditFormUrl","defaultNewFormUrl","documentTemplateUrl","draftVersionVisibility","enableAttachments","enableFolderCreation","enableMinorVersions","enableModeration","enableVersioning","forceCheckout","hidden","isApplicationList","isSiteAssetsLibrary","multipleDataList","noCrawl","onQuickLaunch","validationFormula","validationMessage","direction"];web=c.appContextSite.get_web();listCreationInfo=new SP.ListCreationInformation();if(typeof listObj.title==='undefined'){say('createList cannot create without .title');var args={get_message:function(){return"createList cannot create without .title";},get_stackTrace:function(){return null;}};setTimeout(fail(null,args),500);return defer.promise();}
listCreationInfo.set_title(listObj.title);if(typeof listObj.template==='undefined'){template=SP.ListTemplateType.genericList;}else if(isNaN(listObj.template)){template=SP.ListTemplateType[listObj.template];}else{template=listObj.template;}
listCreationInfo.set_templateType(template);for(var attr in listObj){val_temp=listObj[attr];fn_temp="set_"+attr;if(typeof listCreationInfo[fn_temp]=='function'){listCreationInfo[fn_temp](val_temp);}}
theList=web.get_lists().add(listCreationInfo);for(var attr in listObj){val_temp=listObj[attr];fn_temp="set_"+attr;if(listAttrs.indexOf(attr)>-1){theList[fn_temp](val_temp);}}
theList.update();c.context.load(theList);c.context.executeQueryAsync(success,fail);function success(){if(listObj.fields){$.when(jsom.createListFields(c.context,theList,listObj.fields)).then(function(data){defer.resolve(listObj);},function(error){defer.reject(error);});}else{defer.resolve(listObj);}}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},addListItem:function(c,listTitle,itemObj){var web,theList,theListItem,prop,itemCreateInfo,defer=new $.Deferred();web=c.appContextSite.get_web();theList=web.get_lists().getByTitle(listTitle);itemCreateInfo=new SP.ListItemCreationInformation();theListItem=theList.addItem(itemCreateInfo);for(prop in itemObj){theListItem.set_item(prop,itemObj[prop]);}
theListItem.update();c.context.load(theListItem);c.context.executeQueryAsync(success,fail);function success(){defer.resolve(theListItem.get_id());}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},getListFields:function(c,listTitle){var web,theList,listFields,defer=new $.Deferred();web=c.appContextSite.get_web();theList=web.get_lists().getByTitle(listTitle);listFields=theList.get_fields();c.context.load(theList);c.context.load(listFields);c.context.executeQueryAsync(success,fail);function success(){defer.resolve(listFields);}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},getItems:function(c,listTitle,query){var web,theList,resultCollection,defer=new $.Deferred();web=c.appContextSite.get_web();theList=web.get_lists().getByTitle(listTitle);var camlQuery=new SP.CamlQuery();camlQuery.set_viewXml(query);resultCollection=theList.getItems(camlQuery);c.context.load(resultCollection);c.context.executeQueryAsync(success,fail);function success(){defer.resolve(resultCollection);}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},handleItemsPaginated:function(c,listTitle,query,data,perPage,callBack){var deferred=new $.Deferred(),that=this,perPage=(!perPage)?50:perPage,updatedItems=0,items=[];function _fillItems(c,listTitle,query,perPage){var page=1,itemsDeferred=new $.Deferred();function _getItems(c,listTitle,query,paginginfo,perPage,page){that.getItemsPaginated(c,listTitle,query,paginginfo,page,perPage).then(function(paginationResults){var tempItems=paginationResults.items.get_data();items=items.concat(tempItems);if(paginationResults.nextPage===true){page++;_getItems(c,listTitle,query,paginationResults.nextPagingInfo,perPage,page);}else{itemsDeferred.resolve();}},function(error){itemsDeferred.reject(error);});}
_getItems(c,listTitle,query,null,perPage,page);return itemsDeferred.promise();}
function _handleItems(c,data,perPage,callBack){var tempItems=items.splice(0,perPage),dirtyPage=false;if(tempItems.length>0){say('spliced '+tempItems.length+" items, remaining "+items.length);tempItems.forEach(function(item){if(callBack(item,data)){updatedItems+=1;if(!dirtyPage){dirtyPage=true;}}});if(dirtyPage){c.context.executeQueryAsync(function(){_handleItems(c,data,perPage,callBack);},function(sender,args){deferred.reject({sender:sender,args:args});});}else{_handleItems(c,data,perPage,callBack);}}else{deferred.resolve({updatedItems:updatedItems});}}
_fillItems(c,listTitle,query,perPage).then(function(){_handleItems(c,data,perPage,callBack)},function(error){deferred.reject(error);});return deferred.promise();},getItemsPaginated:function(c,listTitle,query,pagingInfo,page,perPage){var
web,theList,camlQuery=new SP.CamlQuery(),defer=new $.Deferred(),nextPagingInfo,previousPagingInfo,resultsCollection,position=null;if(!page){page=1;}
if(!perPage){perPage=10;}
web=c.appContextSite.get_web();theList=web.get_lists().getByTitle(listTitle);if(!query){query='<View><RowLimit>'+perPage+'</RowLimit></View>';}else{query=query.replace('</View>','<RowLimit>'+perPage+'</RowLimit></View>');}
if(pagingInfo){position=new SP.ListItemCollectionPosition();position.set_pagingInfo(pagingInfo);}
camlQuery.set_listItemCollectionPosition(position);camlQuery.set_viewXml(query);resultsCollection=theList.getItems(camlQuery);c.context.load(resultsCollection);c.context.executeQueryAsync(success,fail);function success(){if(resultsCollection.get_listItemCollectionPosition()){nextPagingInfo=resultsCollection.get_listItemCollectionPosition().get_pagingInfo();}else{nextPagingInfo=null;}
if(page>1){previousPagingInfo="PagedPrev=TRUE&Paged=TRUE&p_ID="+resultsCollection.itemAt(0).get_item('ID');}else{previousPagingInfo=null;}
defer.resolve({startItem:((page-1)*perPage+1),endItem:((page*perPage)-(perPage-resultsCollection.get_count())),prevPage:(page>1?true:false),previousPagingInfo:previousPagingInfo,nextPage:(nextPagingInfo?true:false),nextPagingInfo:nextPagingInfo,items:resultsCollection});}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},updateListItem:function(c,listTitle,itemObj,itemId){var web,theList,theListItem,prop,itemId,itemCreateInfo,defer=new $.Deferred();web=c.appContextSite.get_web();theList=web.get_lists().getByTitle(listTitle);theListItem=theList.getItemById(itemId);for(prop in itemObj){theListItem.set_item(prop,itemObj[prop]);}
theListItem.update();c.context.load(theListItem);c.context.executeQueryAsync(success,fail);function success(){defer.resolve(itemId);}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},recycleListItem:function(c,listTitle,itemId){var web,theList,theListItem,defer=new $.Deferred();web=c.appContextSite.get_web();theList=web.get_lists().getByTitle(listTitle);theListItem=theList.getItemById(itemId);theListItem.recycle();c.context.executeQueryAsync(success,fail);function success(){defer.resolve(itemId);}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},checkList:function(c,listTitle){var web,collectionList,defer=new $.Deferred();if(!c){var args={get_message:function(){return"SP.ClientContext not loaded";},get_stackTrace:function(){return null;}};setTimeout(fail(null,args),500);return defer.promise();}
web=c.appContextSite.get_web();collectionList=web.get_lists();c.context.load(collectionList,'Include(Title)');c.context.executeQueryAsync(success,fail);function success(){var listInfo='',answerBool=false,listEnumerator=collectionList.getEnumerator();while(listEnumerator.moveNext()){var oList=listEnumerator.get_current();if(oList.get_title()==listTitle){answerBool=true;break;}}
defer.resolve(answerBool);}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},removeRecentElemByTitle:function(c,elemTitle,literalsArray){var defer=new $.Deferred();literalsArray=literalsArray||["Recent"];if(!(literalsArray instanceof Array))
literalsArray=[literalsArray];function success(){var msg='element removed from Recent: '+elemTitle;defer.resolve(msg);}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
c.ql=c.appContextSite.get_web().get_navigation().get_quickLaunch();var ql=c.ql;c.context.load(ql);c.context.executeQueryAsync(function(){var objEnumerator=ql.getEnumerator(),navItem,recentsFoundBool,navItemTitle;while(objEnumerator.moveNext()){navItem=objEnumerator.get_current();navItemTitle=navItem.get_title();if($.inArray(navItemTitle,literalsArray)!==-1){recentsFoundBool=true;var ch=navItem.get_children();c.context.load(ch);c.context.executeQueryAsync(function(){var childsEnum=ch.getEnumerator(),childItem,foundBool=false;while(childsEnum.moveNext()){childItem=childsEnum.get_current();if(childItem.get_title()==elemTitle){foundBool=true;childItem.deleteObject();c.context.load(ql);c.context.executeQueryAsync(success,fail);break;}}
if(!foundBool){var args={get_message:function(){return"Recent Element was not found: "+elemTitle;},get_stackTrace:function(){return null;}};setTimeout(fail(null,args),500);}},fail);}}
if(!recentsFoundBool){var args={get_message:function(){return"Recent Node was not found: "+elemTitle;},get_stackTrace:function(){return null;}};setTimeout(fail(null,args),500);}},fail);return defer.promise();},getList:function(c,listTitle){var web,theList,defer=new $.Deferred();web=c.appContextSite.get_web();theList=web.get_lists().getByTitle(listTitle);c.context.load(theList);c.context.executeQueryAsync(success,fail);function success(){defer.resolve(theList);}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},getLists:function(c,columns){var web,lists,columnArg,defer=$.Deferred();web=c.appContextSite.get_web();lists=web.get_lists();if(typeof columns==='string'){columnArg="Include("+columns+")";}else if(Array.isArray(columns)){columnArg="Include("+columns.join()+")";}
if(columnArg){c.context.load(lists,columnArg);}else{c.context.load(lists);}
c.context.executeQueryAsync(success,fail);function success(){defer.resolve(lists);}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},deleteList:function(c,listTitle){var web,theList,defer=new $.Deferred();web=c.appContextSite.get_web();theList=web.get_lists().getByTitle(listTitle);theList.deleteObject();c.context.executeQueryAsync(success,fail);function success(){defer.resolve(listTitle+" deleted");}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},recycleList:function(c,listTitle){var web,theList,defer=new $.Deferred();web=c.appContextSite.get_web();theList=web.get_lists().getByTitle(listTitle);theList.recycle();c.context.executeQueryAsync(success,fail);function success(){defer.resolve(listTitle+" recycled");}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},getListPermissions:function(c,listTitle,userName){var web,theList,userPerms,defer=new $.Deferred();web=c.appContextSite.get_web();theList=web.get_lists().getByTitle(listTitle);userPerms=theList.getUserEffectivePermissions(userName);c.context.load(theList,'EffectiveBasePermissions');c.context.executeQueryAsync(success,fail);function success(){defer.resolve(userPerms);}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},getListItemHasUniquePerms:function(c,listTitle,itemIdOrFilename){var web,theList,queryStr,resultCollection,defer=new $.Deferred(),camlQuery=new SP.CamlQuery();web=c.appContextSite.get_web();theList=web.get_lists().getByTitle(listTitle);if(!isNaN(itemIdOrFilename)){queryStr="<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Counter'>"
+itemIdOrFilename+"</Value></Eq></Where></Query></View>";}else{queryStr="<View><Query><Where><Eq><FieldRef Name='FileLeafRef'/><Value Type='File'>"
+itemIdOrFilename+"</Value></Eq></Where></Query></View>";}
camlQuery.set_viewXml(queryStr);var resultCollection=theList.getItems(camlQuery);c.context.load(resultCollection,"Include(Title, DisplayName, HasUniqueRoleAssignments)");c.context.executeQueryAsync(success,fail);function success(){var answerBool,itemTitle,listEnumerator=resultCollection.getEnumerator();while(listEnumerator.moveNext()){var oListItem=listEnumerator.get_current();answerBool=oListItem.get_hasUniqueRoleAssignments();}
defer.resolve(answerBool);}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},getAllListsHasUniquePerms:function(c){var web,theList,defer=new $.Deferred(),collectionList;web=c.appContextSite.get_web();collectionList=web.get_lists();c.context.load(collectionList,'Include(Title, HasUniqueRoleAssignments)');c.context.executeQueryAsync(success,fail);function success(){var listInfo='',answerBool,title,resultsArray=[],listEnumerator=collectionList.getEnumerator();while(listEnumerator.moveNext()){var tempObj,oList=listEnumerator.get_current();tempObj={title:oList.get_title(),hasUniqePerms:oList.get_hasUniqueRoleAssignments()};resultsArray.push(tempObj);}
defer.resolve(resultsArray);}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},getListHasUniquePerms:function(c,listTitle){var web,theList,defer=new $.Deferred(),collectionList;web=c.appContextSite.get_web();collectionList=web.get_lists();c.context.load(collectionList,'Include(Title, HasUniqueRoleAssignments)');c.context.executeQueryAsync(success,fail);function success(){var listInfo='',answerBool=-1,listEnumerator=collectionList.getEnumerator();while(listEnumerator.moveNext()){var oList=listEnumerator.get_current();if(oList.get_title()==listTitle){answerBool=oList.get_hasUniqueRoleAssignments();break;}}
if(answerBool==-1){var args={get_message:function(){return"List was not found: "+elemTitle;},get_stackTrace:function(){return null;}};fail(null,args);}else{defer.resolve(answerBool);}}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},getCurrentUser:function(c){var defer=new $.Deferred();user=c.context.get_web().get_currentUser();c.context.load(user);c.context.executeQueryAsync(success,fail);function success(){defer.resolve(user);}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},getWebProperty:function(c,propName,storageObjName){var web,properties,val,defer=new $.Deferred();web=c.appContextSite.get_web();properties=web.get_allProperties();web.update();c.context.load(web);c.context.load(properties);c.context.executeQueryAsync(success,fail);function success(){webPropertiesStorage[storageObjName]=properties.get_fieldValues();var val=webPropertiesStorage[storageObjName][propName];defer.resolve(val);}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},setWebProperty:function(c,propName,val,storageObjName){var web,properties,defer=new $.Deferred();web=c.appContextSite.get_web();properties=web.get_allProperties();properties.set_item(propName,val);web.update();c.context.load(web);c.context.executeQueryAsync(success,fail);function success(obj){webPropertiesStorage[storageObjName][propName]=val;defer.resolve(obj);}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},deleteFile:function(c,fileServerRelativeUrl){var web,file,defer=new $.Deferred();web=c.appContextSite.get_web();file=web.getFileByServerRelativeUrl(fileServerRelativeUrl);c.context.load(web);file.deleteObject();c.context.executeQueryAsync(success,fail);function success(obj){defer.resolve(obj);}
function fail(sender,args){var error={sender:sender,args:args};defer.reject(error);}
return defer.promise();},createFile:function(c,doclib,fname,body,overwriteBool){var web,theLib,fileCreateInfo,newFile,defer=new $.Deferred();web=c.appContextSite.get_web();theLib=web.get_lists().getByTitle(doclib);fileCreateInfo=new SP.FileCreationInformation();fileCreateInfo.set_url(fname);fileCreateInfo.set_content(new SP.Base64EncodedByteArray());fileCreateInfo.set_overwrite(overwriteBool||false);var converted_arr=strToUTF8Arr(body);for(var i=0;i<converted_arr.length;++i){fileCreateInfo.get_content().append(converted_arr[i]);}
newFile=theLib.get_rootFolder().get_files().add(fileCreateInfo);c.context.load(newFile);c.context.executeQueryAsync(successHandler,errorHandler);function successHandler(){defer.resolve(newFile.get_serverRelativeUrl());}
function errorHandler(sender,args){defer.reject(args.get_message());}
function strToUTF8Arr(sDOMStr){var aBytes,nChr,nStrLen=sDOMStr.length,nArrLen=0;for(var nMapIdx=0;nMapIdx<nStrLen;nMapIdx++){nChr=sDOMStr.charCodeAt(nMapIdx);nArrLen+=nChr<0x80?1:nChr<0x800?2:nChr<0x10000?3:nChr<0x200000?4:nChr<0x4000000?5:6;}
aBytes=new Uint8Array(nArrLen);for(var nIdx=0,nChrIdx=0;nIdx<nArrLen;nChrIdx++){nChr=sDOMStr.charCodeAt(nChrIdx);if(nChr<128){aBytes[nIdx++]=nChr;}else if(nChr<0x800){aBytes[nIdx++]=192+(nChr>>>6);aBytes[nIdx++]=128+(nChr&63);}else if(nChr<0x10000){aBytes[nIdx++]=224+(nChr>>>12);aBytes[nIdx++]=128+(nChr>>>6&63);aBytes[nIdx++]=128+(nChr&63);}else if(nChr<0x200000){aBytes[nIdx++]=240+(nChr>>>18);aBytes[nIdx++]=128+(nChr>>>12&63);aBytes[nIdx++]=128+(nChr>>>6&63);aBytes[nIdx++]=128+(nChr&63);}else if(nChr<0x4000000){aBytes[nIdx++]=248+(nChr>>>24);aBytes[nIdx++]=128+(nChr>>>18&63);aBytes[nIdx++]=128+(nChr>>>12&63);aBytes[nIdx++]=128+(nChr>>>6&63);aBytes[nIdx++]=128+(nChr&63);}else
{aBytes[nIdx++]=252+
(nChr/1073741824);aBytes[nIdx++]=128+(nChr>>>24&63);aBytes[nIdx++]=128+(nChr>>>18&63);aBytes[nIdx++]=128+(nChr>>>12&63);aBytes[nIdx++]=128+(nChr>>>6&63);aBytes[nIdx++]=128+(nChr&63);}}
return aBytes;}
return defer.promise();},createFolder:function(c,docLib,folderName){var
web=c.appContextSite.get_web(),theLib=web.get_lists().getByTitle(docLib),folderItem,itemCreateInfo,defer=new $.Deferred();itemCreateInfo=new SP.ListItemCreationInformation();itemCreateInfo.set_underlyingObjectType(SP.FileSystemObjectType.folder);itemCreateInfo.set_leafName(folderName);folderItem=theLib.addItem(itemCreateInfo);folderItem.update();c.context.load(folderItem);c.context.executeQueryAsync(function(){defer.resolve(true);},function(sender,args){defer.reject({sender:sender,args:args});});return defer.promise();}};spyreqs={rest:{getHostLists:function(query){var url=baseUrl+"web/lists?"+checkQuery(query)+targetStr;return getAsync(url);},getAppLists:function(query){var url=appUrl+"/_api/web/lists?"+checkQuery(query);return getAsync(url);},getHostListByTitle:function(listTitle,query){var url=baseUrl+"web/lists/getByTitle('"+listTitle+"')?"+checkQuery(query)+targetStr;return getAsync(url);},getAppListByTitle:function(listTitle,query){var url=appUrl+"/_api/web/lists/getByTitle('"+listTitle+"')?"+checkQuery(query);return getAsync(url);},getHostListItems:function(listTitle,query){var url=baseUrl+"web/lists/getByTitle('"+listTitle+"')/Items?"+checkQuery(query)+targetStr;return getAsync(url);},getAppListItems:function(listTitle,query){var url=appUrl+"/_api/web/lists/getByTitle('"+listTitle+"')/Items?"+checkQuery(query);return getAsync(url);},getHostListFields:function(listTitle,query){var url=baseUrl+"web/lists/getByTitle('"+listTitle+"')/Fields?"+checkQuery(query)+targetStr;return getAsync(url);},getAppListFields:function(listTitle,query){var url=appUrl+"/_api/web/lists/getByTitle('"+listTitle+"')/Fields?"+checkQuery(query);return getAsync(url);},createHostList:function(list){var url=baseUrl+"web/lists?"+targetStr;return rest.createList(url,list);},createAppList:function(list){var url=appUrl+"/_api/web/lists?";return rest.createList(url,list);},addHostListItem:function(listTitle,item){var url=baseUrl+"web/lists/getByTitle('"+listTitle+"')/Items?"+targetStr;return createAsync(url,item);},addAppListItem:function(listTitle,item){var url=appUrl+"/_api/web/lists/getByTitle('"+listTitle+"')/Items?";return createAsync(url,item);},deleteHostListItem:function(listTitle,itemId,etag){var url=baseUrl+"web/lists/getByTitle('"+listTitle+"')/Items("+itemId+")?"+targetStr;return deleteAsync(url,etag);},deleteAppListItem:function(listTitle,itemId,etag){var url=appUrl+"/_api/web/lists/getByTitle('"+listTitle+"')/Items("+itemId+")?";return deleteAsync(url,etag);},updateHostList:function(list){var url=baseUrl+"web/lists/getByTitle('"+list.Title+"')?"+targetStr;return updateAsync(url,list);},updateHostListItem:function(listTitle,item){var url=baseUrl+"web/lists/getByTitle('"+listTitle+"')/Items("+item.Id+")?"+targetStr;return updateAsync(url,item);},updateAppListItem:function(listTitle,item){var url=appUrl+"/_api/web/lists/getByTitle('"+listTitle+"')/Items("+item.Id+")?";return updateAsync(url,item);},updateHostListField:function(listTitle,field){var url=baseUrl+"web/lists/getByTitle('"+listTitle+"')/Fields(guid'"+field.Id+"')?"+targetStr;return updateAsync(url,field);},updateAppListField:function(listTitle,field){var url=appUrl+"/_api/web/lists/getByTitle('"+listTitle+"')/Fields(guid'"+field.Id+"')?";return updateAsync(url,field);},addHostListField:function(listGuid,field,fieldType){var url=baseUrl+"web/lists(guid'"+listGuid+"')/Fields?"+targetStr;return rest.addListField(url,field,fieldType);},addAppListField:function(listGuid,field,fieldType){var url=appUrl+"/_api/web/lists(guid'"+listGuid+"')/Fields?";return rest.addListField(url,field,fieldType);},getCurrentUser:function(){var url=baseUrl+"/web/CurrentUser?"+targetStr;return getAsync(url);},getHostFile:function(fileUrl){var url=baseUrl+"web/GetFileByServerRelativeUrl('"+fileUrl+"')/$value?"+targetStr;return getFile(url);},getAppFile:function(fileUrl){var url=appUrl+"/_api/web/GetFileByServerRelativeUrl('"+fileUrl+"')/$value?";return getFile(url);},getHostFolderFiles:function(folderName){var url=baseUrl+"web/GetFolderByServerRelativeUrl('"+folderName+"')/Files?"+targetStr;return getAsync(url);},getHostFolderFolders:function(folderName){var url=baseUrl+"web/GetFolderByServerRelativeUrl('"+folderName+"')/Folders?"+targetStr;return getAsync(url);},getAppFolderFiles:function(folderName){var url=appUrl+"/_api/web/GetFolderByServerRelativeUrl('"+folderName+"')/Files?";return getAsync(url);},getAppFolderFolders:function(folderName){var url=appUrl+"/_api/web/GetFolderByServerRelativeUrl('"+folderName+"')/Folders?";return getAsync(url);},addAppFolder:function(documentLibrary,folderName){var url=appUrl+"/_api/web/folders?",folderName=documentLibrary+"/"+folderName,data={'__metadata':{'type':'SP.Folder'},'ServerRelativeUrl':folderName};return addFolder(url,data);},deleteAppFolder:function(documentLibrary,folderName){var url=appUrl+"/_api/web/GetFolderByServerRelativeUrl('"+
documentLibrary+"/"+folderName+"')";return deleteAsync(url);},addHostFolder:function(documentLibrary,folderName){var url=baseUrl+"web/folders?"+targetStr,folderName=documentLibrary+"/"+folderName,data={'__metadata':{'type':'SP.Folder'},'ServerRelativeUrl':folderName};return addFolder(url,data);},addHostFile:function(folderName,fileName,file){var url=baseUrl+"web/GetFolderByServerRelativeUrl('"+folderName+"')/Files/Add(url='"+fileName+"',overwrite=true)?"+targetStr;return addFile(url,file);},addAppFile:function(folderName,fileName,file){var url=appUrl+"/_api/web/GetFolderByServerRelativeUrl('"+folderName+"')/Files/Add(url='"+fileName+"',overwrite=true)?";return addFile(url,file);},addHostBinaryFile:function(folderName,fileName,file,overwrite,xhrObj){var xhr=new XMLHttpRequest(),canSendBinary=!!((!!(xhr.sendAsBinary||xhr.upload))||(window.Uint8Array&&window.ArrayBuffer)),dataAccessSupport=!!(File&&(File.prototype.getAsDataURL||window.FileReader)&&canSendBinary);if(!dataAccessSupport){return new $.Deferred().reject({mesage:"addHostBinaryFile is not supported by your browser"});}
if(!(file instanceof File||File instanceof Blob)){return new $.Deferred().reject({mesage:"File cannot be read"});}
if(overwrite!==false){overwrite=true;}
var url=baseUrl+"/web/GetFolderByServerRelativeUrl('"+folderName+"')/Files/Add(url='"+fileName+"',overwrite="+overwrite+")?"+targetStr;return addBinaryFile(url,file,xhrObj);},addAppBinaryFile:function(folderName,fileName,file,overwrite,xhrObj){var xhr=new XMLHttpRequest(),canSendBinary=!!((!!(xhr.sendAsBinary||xhr.upload))||(window.Uint8Array&&window.ArrayBuffer)),dataAccessSupport=!!(File&&(File.prototype.getAsDataURL||window.FileReader)&&canSendBinary);if(!dataAccessSupport){return new $.Deferred().reject({mesage:"addAppBinaryFileWithProgress is not supported by your browser"});}
if(!(file instanceof File||File instanceof Blob)){return new $.Deferred().reject({mesage:"File cannot be read"});}
if(overwrite!==false){overwrite=true;}
var url=appUrl
+"/_api/web/GetFolderByServerRelativeUrl('"
+folderName
+"')/Files/Add(url='"
+fileName
+"',overwrite="
+overwrite+")?";return addBinaryFile(url,file,xhrObj);},getHostListItemAttachments:function(listTitle,itemId){var url=baseUrl+"web/lists/getByTitle('"+listTitle+"')/Items("+itemId+")/AttachmentFiles?"+targetStr;return getAsync(url);},addHostListItemAttachment:function(listTitle,itemId,fileName,file){var url=baseUrl+"web/lists/getByTitle('"+listTitle+"')/Items("+itemId+")/AttachmentFiles/add(FileName='"+fileName+"')?"+targetStr;return createAsync(url,file);},getSiteUsers:function(query){var url=baseUrl+"web/SiteUsers?"+checkQuery(query)+targetStr;return getAsync(url);},breakRoleInheritanceOfHostList:function(listTitle,copyRolesStr,clearSubScopeStr){var defer=new $.Deferred(),copyRolesStr=copyRolesStr||"true",clearSubScopeStr=clearSubScopeStr||"false",url=baseUrl+"web/lists/getByTitle('"+listTitle+"')/breakroleinheritance(copyRoleAssignments ="+copyRolesStr+",clearSubscopes ="+clearSubScopeStr+")?"+targetStr;return postAsync(url);},breakRoleInheritanceOfAppList:function(listTitle,copyRolesStr,clearSubScopeStr){var defer=new $.Deferred(),copyRolesStr=copyRolesStr||"true",clearSubScopeStr=clearSubScopeStr||"false",url=appUrl+"/_api/web/lists/getByTitle('"+listTitle+"')/breakroleinheritance(copyRoleAssignments ="+copyRolesStr+",clearSubscopes ="+clearSubScopeStr+")?";return postAsync(url);},resetRoleInheritanceOfAppList:function(listTitle){var defer=new $.Deferred(),url=appUrl+"/_api/web/lists/getByTitle('"+listTitle+"')/resetroleinheritance?";return postAsync(url);},resetRoleInheritanceOfHostList:function(listTitle){var defer=new $.Deferred(),url=baseUrl+"web/lists/getByTitle('"+listTitle+"')/resetroleinheritance?"+targetStr;return postAsync(url);},givePermissionToGroupToAppList:function(listTitle,permissionName,groupName){var groupId;return this.breakRoleInheritanceOfAppList(listTitle).then(function(){var url=appUrl+"/_api/web/sitegroups/getByName('"+groupName+"')?$select=Id";return getAsync(url);}).then(function(groupData){var url;groupId=groupData.d.Id;url=appUrl+"/_api/web/lists/getbytitle('"+listTitle+"')/roleassignments/getbyprincipalid('"+groupId+"')";return deleteAsync(url);}).then(function(){var url=appUrl+"/_api/web/roledefinitions/getByName('"+permissionName+"')?select=Id";return getAsync(url);}).done(function(permissionData){var url=appUrl+"/_api/web/lists/getbytitle('"+listTitle+"')/roleassignments/"+"addroleassignment(principalid="+groupId+",roledefid="+permissionData.d.Id+")",defer=new $.Deferred();executor.executeAsync({url:url,method:'POST',headers:{Accept:"application/json;odata=verbose"},success:defer.resolve,error:defer.reject});return defer.promise();});},getHostListRoleAssigmnent:function(listTitle,userId){var url=baseUrl+"web/lists/getbytitle('"+listTitle+"')/roleassignments/getbyprincipalid('"+userId+"')?"+targetStr;return getAsync(url);},breakRoleInheritanceOfHostWeb:function(copyRolesStr,clearSubScopeStr){var defer=new $.Deferred(),copyRolesStr=copyRolesStr||"true",clearSubScopeStr=clearSubScopeStr||"false",url=baseUrl+"web/breakroleinheritance(copyRoleAssignments ="+copyRolesStr+",clearSubscopes ="+clearSubScopeStr+")?"+targetStr;return postAsync(url);},breakRoleInheritanceOfAppWeb:function(copyRolesStr,clearSubScopeStr){var defer=new $.Deferred(),copyRolesStr=copyRolesStr||"true",clearSubScopeStr=clearSubScopeStr||"false",url=appUrl+"/_api/web/breakroleinheritance(copyRoleAssignments ="+copyRolesStr+",clearSubscopes ="+clearSubScopeStr+")?";return postAsync(url);},resetRoleInheritanceOfHostWeb:function(){var defer=new $.Deferred(),url=baseUrl+"web/resetroleinheritance?"+targetStr;return postAsync(url);},resetRoleInheritanceOfAppWeb:function(){var defer=new $.Deferred(),url=appUrl+"/_api/web/resetroleinheritance?";return postAsync(url);},postAsync:postAsync,getAsync:getAsync},jsom:{checkHostList:function(listTitle){var c=newRemoteContextInstance();return jsom.checkList(c,listTitle);},checkAppList:function(listTitle){var c=newLocalContextInstance();return jsom.checkList(c,listTitle);},getCurrentUser:function(){var c=newLocalContextInstance();return jsom.getCurrentUser(c);},getHostList:function(listTitle){var c=newRemoteContextInstance();return jsom.getList(c,listTitle);},getAppList:function(listTitle){var c=newLocalContextInstance();return jsom.getList(c,listTitle);},getAppLists:function(columns){var c=newLocalContextInstance();return jsom.getLists(c,columns);},getHostLists:function(columns){var c=newRemoteContextInstance();return jsom.getLists(c,columns);},deleteHostList:function(listTitle){var c=newRemoteContextInstance();return jsom.deleteList(c,listTitle);},deleteAppList:function(listTitle){var c=newLocalContextInstance();return jsom.deleteList(c,listTitle);},recycleHostList:function(listTitle){var c=newRemoteContextInstance();return jsom.recycleList(c,listTitle);},recycleAppList:function(listTitle){var c=newLocalContextInstance();return jsom.recycleList(c,listTitle);},getAppListPermissions:function(listTitle,userName){var c=newLocalContextInstance();return jsom.getListPermissions(c,listTitle,userName);},getHostListPermissions:function(listTitle,userName){say("CAUTION, spyreqs says: getHostListPermissions only works with full control on host web");var c=newRemoteContextInstance();return jsom.getListPermissions(c,listTitle,userName);},getAppListFields:function(listTitle){var c=newLocalContextInstance();return jsom.getListFields(c,listTitle);},getHostListFields:function(listTitle){var c=newRemoteContextInstance();return jsom.getListFields(c,listTitle);},getHostListItems:function(listTitle,query){var c=newRemoteContextInstance();return jsom.getItems(c,listTitle,query);},getAppListItems:function(listTitle,query){var c=newLocalContextInstance();return jsom.getItems(c,listTitle,query);},getAppListItemsPaginated:function(listTitle,query,pagingInfo,page,perPage){var c=new newLocalContextInstance();return jsom.getItemsPaginated(c,listTitle,query,pagingInfo,page,perPage);},getHostListItemsPaginated:function(listTitle,query,pagingInfo,page,perPage){var c=new newRemoteContextInstance();return jsom.getItemsPaginated(c,listTitle,query,pagingInfo,page,perPage);},updateHostListItemsPaginated:function(listTitle,query,data,perPage){var c=new newRemoteContextInstance();var callBack=function(item,data){var dirty=false;for(var property in data){if(item.get_item(property)!==data[property]){item.set_item(property,data[property]);dirty=true;}}
if(dirty){item.update();return true;}
return false;};return jsom.handleItemsPaginated(c,listTitle,query,data,perPage,callBack);},recycleHostListItemsPaginated:function(listTitle,query,data,perPage){var c=new newRemoteContextInstance();var callBack=function(item,data){item.recycle();return true;};return jsom.handleItemsPaginated(c,listTitle,query,data,perPage,callBack);},deleteHostListItemsPaginated:function(listTitle,query,data,perPage){var c=new newRemoteContextInstance();var callBack=function(item,data){item.deleteObject();return true;};return jsom.handleItemsPaginated(c,listTitle,query,data,perPage,callBack);},deleteAppListItemsPaginated:function(listTitle,query,data,perPage){var c=new newLocalContextInstance();var callBack=function(item,data){item.deleteObject();return true;};return jsom.handleItemsPaginated(c,listTitle,query,data,perPage,callBack);},addHostListItem:function(listTitle,itemObj){var c=newRemoteContextInstance();return jsom.addListItem(c,listTitle,itemObj);},addAppListItem:function(listTitle,itemObj){var c=newLocalContextInstance();return jsom.addListItem(c,listTitle,itemObj);},updateAppListItem:function(listTitle,itemObj,itemId){var c=newLocalContextInstance();return jsom.updateListItem(c,listTitle,itemObj,itemId);},updateHostListItem:function(listTitle,itemObj,itemId){var c=newRemoteContextInstance();return jsom.updateListItem(c,listTitle,itemObj,itemId);},recycleHostListItem:function(listTitle,itemId){var c=newRemoteContextInstance();return jsom.recycleListItem(c,listTitle,itemId);},recycleAppListItem:function(listTitle,itemId){var c=newLocalContextInstance();return jsom.recycleListItem(c,listTitle,itemId);},removeHostRecentElemByTitle:function(elemTitle,literalsArray){var c=newRemoteContextInstance();return jsom.removeRecentElemByTitle(c,elemTitle,literalsArray);},removeAppRecentElemByTitle:function(elemTitle,literalsArray){var c=newLocalContextInstance();return jsom.removeRecentElemByTitle(c,elemTitle,literalsArray);},createHostList:function(listObj){var c=newRemoteContextInstance();return jsom.createList(c,listObj);},createAppList:function(listObj){var c=newLocalContextInstance();return jsom.createList(c,listObj);},createHostSite:function(title,template,url,inheritPermsBool,language,description){var defer=$.Deferred(),c=spyreqs.jsom.getTestHostContext(),websColl,webCreationInfo,newWeb;websColl=c.appContextSite.get_web().get_webs();webCreationInfo=new SP.WebCreationInformation();webCreationInfo.set_title(title);webCreationInfo.set_webTemplate(templateGuid);webCreationInfo.set_url(url);webCreationInfo.set_description(description);webCreationInfo.set_language(language);webCreationInfo.set_useSamePermissionsAsParentSite(inheritPermsBool);newWeb=websColl.add(webCreationInfo);c.context.load(newWeb);c.context.executeQueryAsync(function(){defer.resolve(true);},function(sender,args){var error={sender:sender,args:args};defer.reject(error);});return defer.promise();},getHostListItemHasUniquePerms:function(listTitle,itemIdOrFilename){var c=newRemoteContextInstance();return jsom.getListItemHasUniquePerms(c,listTitle,itemIdOrFilename);},getAppListItemHasUniquePerms:function(listTitle,itemIdOrFilename){var c=newLocalContextInstance();return jsom.getListItemHasUniquePerms(c,listTitle,itemIdOrFilename);},getAllHostListsHasUniquePerms:function(){var c=newRemoteContextInstance();return jsom.getAllListsHasUniquePerms(c);},getAllAppListsHasUniquePerms:function(){var c=newLocalContextInstance();return jsom.getAllListsHasUniquePerms(c);},getHostListHasUniquePerms:function(listTitle){var c=newRemoteContextInstance();return jsom.getListHasUniquePerms(c,listTitle);},addUserToRoleTypeInAppWeb:function(userOrUserId,SPRoleType){var
deferred=$.Deferred(),c=new newLocalContextInstance(),context=c.appContextSite,web=context.get_web(),assignments=web.get_roleAssignments(),roleAssignments,user,roleTypeDefinition,newBindings=SP.RoleDefinitionBindingCollection.newObject(context);if(userOrUserId instanceof SP.User){userOrUserId=userOrUserId.get_id();}
user=web.getUserById(userOrUserId);roleTypeDefinition=web.get_roleDefinitions().getByType(SPRoleType);newBindings.add(roleTypeDefinition);roleAssignments=assignments.add(user,newBindings);context.executeQueryAsync(function(){deferred.resolve(true);},function(sender,args){var error={sender:sender,args:args};deferred.reject(error);});return deferred.promise();},addUserToRoleTypeInAppList:function(userOrUserId,SPRoleType,listTitle){var
deferred=$.Deferred(),c=new newLocalContextInstance(),context=c.appContextSite,web=context.get_web(),SPListObj=web.get_lists().getByTitle(listTitle),assignments=SPListObj.get_roleAssignments(),user,roleTypeDefinition,roleAssignment,newBindings=SP.RoleDefinitionBindingCollection.newObject(context);if(userOrUserId instanceof SP.User){userOrUserId=userOrUserId.get_id();}
user=web.getUserById(userOrUserId);roleTypeDefinition=web.get_roleDefinitions().getByType(SPRoleType);newBindings.add(roleTypeDefinition);roleAssignment=assignments.add(user,newBindings);context.executeQueryAsync(function(){deferred.resolve(true);},function(sender,args){var error={sender:sender,args:args};deferred.reject(error);});return deferred.promise();},addUserToRoleTypeInAppListItem:function(userOrUserId,SPRoleType,listTitle,itemId){var
deferred=$.Deferred(),c=new newLocalContextInstance(),context=c.appContextSite,web=context.get_web(),SPListItemObj=web.get_lists().getByTitle(listTitle).getItemById(itemId),assignments=SPListItemObj.get_roleAssignments(),roleAssignment,user,roleDefOfRoleType=web.get_roleDefinitions().getByType(SPRoleType),newBindings=SP.RoleDefinitionBindingCollection.newObject(context);newBindings.add(roleDefOfRoleType);if(userOrUserId instanceof SP.User){userOrUserId=userOrUserId.get_id();}
user=web.getUserById(userId);roleAssignment=assignments.add(user,newBindings);context.executeQueryAsync(function(){deferred.resolve(true);},function(sender,args){var error={sender:sender,args:args};deferred.reject(error);});return deferred.promise();},getAppListHasUniquePerms:function(listTitle){var c=newLocalContextInstance();return jsom.getListHasUniquePerms(c,listTitle);},getTestAppContext:function(){var c=newLocalContextInstance();c.getter=c.appContextSite;c.loader=c.context;return c;},getTestHostContext:function(){var c=newRemoteContextInstance();c.getter=c.appContextSite;c.loader=c.context;return c;},getHostProperty:function(propName){if(webPropertiesStorage["hostWebProperties"].isUnloaded){var c=newRemoteContextInstance();return jsom.getWebProperty(c,propName,"hostWebProperties");}else{var val=webPropertiesStorage["hostWebProperties"][propName];return new $.Deferred().resolve(val).promise();}},getAppProperty:function(propName){if(webPropertiesStorage["appWebProperties"].isUnloaded){var c=newLocalContextInstance();return jsom.getWebProperty(c,propName,"appWebProperties");}else{var val=webPropertiesStorage["appWebProperties"][propName];return new $.Deferred().resolve(val).promise();}},setHostProperty:function(propName,val){var c=newRemoteContextInstance();return jsom.setWebProperty(c,propName,val,"hostWebProperties");},setAppProperty:function(propName,val){var c=newLocalContextInstance();return jsom.setWebProperty(c,propName,val,"appWebProperties");},createAppFile:function(doclib,fname,body,overwriteBool){var c=newLocalContextInstance();return jsom.createFile(c,doclib,fname,body,overwriteBool);},createHostFile:function(doclib,fname,body,overwriteBool){var c=newRemoteContextInstance();return jsom.createFile(c,doclib,fname,body,overwriteBool);},createAppFolder:function(docLib,folderName){var c=newLocalContextInstance();return jsom.createFolder(c,docLib,folderName);},createHostFolder:function(docLib,folderName){var c=newRemoteContextInstance();return jsom.createFolder(c,docLib,folderName);},deleteAppFile:function(fileServerRelativeUrl){var c=newLocalContextInstance();return jsom.deleteFile(c,fileServerRelativeUrl);},deleteHostFile:function(fileServerRelativeUrl){var c=newRemoteContextInstance();return jsom.deleteFile(c,fileServerRelativeUrl);}},utils:{urlParamsObj:urlParamsObj,buildQueryString:buildQueryString,say:say,getRegionalSettings:function(query){var url=baseUrl+"/web/RegionalSettings?"+checkQuery(query)+targetStr;return getAsync(url);},getQueryParams:function(){return queryParams;},getAppUrl:function(){return appUrl;},getHostUrl:function(){return hostUrl;},setAppUrl:function(param){appUrl=param;},setHostUrl:function(param){hostUrl=param;},startMyTimer:function(){return window.performance.now();},getMyTimer:function(tima){return window.performance.now()-tima;}},version:function(){say("Hello, spyreqs ver "+spyreqs_version);return spyreqs_version;},isReady:function(){return isReady;},spContext:null};initTimer=setInterval(testReady,500);if(notAnApp_FlagSum==2){window.spyreqs=mirrorAppFunctions(spyreqs,['rest','jsom','utils']);}else{window.spyreqs=spyreqs;}}
(window));